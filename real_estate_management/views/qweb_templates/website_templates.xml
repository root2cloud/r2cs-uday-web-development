<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="property_map_template" name="Property Map Page">
        <t t-call="website.layout">
            <t t-set="title">Properties in Vishakhapatnam</t>

            <div id="wrap">
                <main class="container my-5">
                    <div class="row">
                        <div class="col-12">
                            <h1 class="text-center mb-4">Properties in Vishakhapatnam</h1>
                            <p class="text-center">
                                Found
                                <span t-esc="property_count"/>
                                properties
                            </p>

                            <div id="propertyMap"
                                 style="height: 500px; width: 100%; border: 2px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                                    Loading map...
                                </div>
                            </div>

                            <div id="property-info" class="mt-3">
                                <p class="text-center text-muted">Click on a pin to see property details</p>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- Hidden JSON data -->
            <div id="property-data" t-att-data-properties="properties_json" style="display:none;"></div>

            <!-- Leaflet CSS -->
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

            <!-- Leaflet JS -->
            <script defer="defer" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


            <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', function() {
                var propertyDataEl = document.getElementById('property-data');
                if (!propertyDataEl) {
                console.error('Property data element not found');
                return;
                }

                var jsonStr = propertyDataEl.getAttribute('data-properties');
                var propertyData = [];
                try {
                propertyData = JSON.parse(jsonStr);
                } catch (e) {
                console.error('Failed to parse property JSON:', e);
                return;
                }

                function initializeMap() {
                if (typeof L === 'undefined') {
                console.log('Leaflet not yet loaded, retrying...');
                setTimeout(initializeMap, 200);
                return;
                }

                var mapContainer = document.getElementById('propertyMap');
                if (!mapContainer) {
                console.error('Map container not found');
                return;
                }

                mapContainer.innerHTML = '';
                var map = L.map('propertyMap').setView([17.6868, 83.218], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19,
                }).addTo(map);

                propertyData.forEach(function(prop) {
                if (prop.latitude &amp;&amp; prop.longitude) {
                var marker = L.marker([prop.latitude, prop.longitude]).addTo(map);
                var popup = `
                <div style="min-width:200px;">
                    <h6>
                        <strong>${prop.name}</strong>
                    </h6>
                    <p>${prop.street}, ${prop.locality}</p>
                    ${prop.price > 0 ? `<p>Price: ₹${prop.price.toLocaleString()}</p>` : ''}
                    ${prop.contact_phone ? `<p>Phone: ${prop.contact_phone}</p>` : ''}
                </div>
                `;
                marker.bindPopup(popup);
                marker.on('click', function() {
                document.getElementById('property-info').innerHTML = `
                <div class="alert alert-info">
                    <h5>${prop.name}</h5>
                    <p>${prop.street}, ${prop.locality}</p>
                    ${prop.price > 0 ? `<p>Price: ₹${prop.price.toLocaleString()}</p>` : ''}
                </div>
                `;
                });
                }
                });

                if (propertyData.length) {
                var group = L.featureGroup(
                propertyData.filter(p => p.latitude &amp;&amp; p.longitude)
                .map(p => L.marker([p.latitude, p.longitude]))
                );
                map.fitBounds(group.getBounds().pad(0.1));
                }
                }

                initializeMap();
                });
            </script>
        </t>
    </template>
</odoo>
